<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Øª Ø£Ø¨Ùˆ Ø£Ù…ÙŠØ± (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body{
            font-family:'Segoe UI',sans-serif;
            margin:0;
            height:100vh;
            display:flex;
            justify-content:center;
            align-items:center;
            background:linear-gradient(135deg,#161e2f 0%,#080d19 100%);
        }
        .app-container{
            width:100%;
            max-width:600px;
            height:100vh;
            background:#fff;
            display:flex;
            flex-direction:column;
        }
        .chat-header{
            background:#008069;
            color:#fff;
            padding:10px 15px;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }
        .messages-area{
            flex:1;
            padding:20px;
            overflow-y:auto;
            background:#e5ddd5;
            background-image:url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            display:flex;
            flex-direction:column;
            gap:10px;
        }
        .message{
            padding:8px 10px;
            border-radius:10px;
            max-width:80%;
        }
        .message.mine{
            align-self:flex-end;
            background:#dcf8c6;
        }
        .message.others{
            align-self:flex-start;
            background:#fff;
        }
        .sender-name{
            font-size:11px;
            color:#d35400;
            font-weight:bold;
            display:block;
            margin-bottom:2px;
        }
        .msg-time{
            font-size:10px;
            color:#555;
            display:block;
            margin-top:3px;
        }
        .input-area{
            display:flex;
            align-items:center;
            padding:10px;
            gap:5px;
            border-top:1px solid #ddd;
            background:#f5f5f5;
        }
        .input-area input[type=text]{
            flex:1;
            padding:8px 10px;
            border-radius:20px;
            border:1px solid #ccc;
        }
        .icon-btn{
            border:none;
            background:transparent;
            cursor:pointer;
            font-size:18px;
        }

        /* Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .modal{
            position:fixed;
            inset:0;
            display:flex;
            justify-content:center;
            align-items:center;
            background:rgba(0,0,0,0.5);
            z-index:9998;
        }
        .modal-box{
            background:rgba(255,255,255,0.1);
            backdrop-filter:blur(10px);
            border:1px solid rgba(255,255,255,0.2);
            box-shadow:0 8px 32px rgba(0,0,0,0.37);
            border-radius:20px;
            color:#f3f3f3;
            padding:40px 30px;
            width:90%;
            max-width:400px;
        }
        .modal-box .title{
            font-size:28px;
            color:#ffcc00;
            margin-bottom:5px;
            text-align:center;
        }
        .input-group{margin-bottom:15px;}
        .modal-box input{
            width:100%;
            padding:12px;
            border-radius:10px;
            border:1px solid #4b5563;
            background:rgba(255,255,255,0.05);
            color:#fff;
            box-sizing:border-box;
        }
        .modal-box input:focus{
            outline:none;
            border-color:#ffcc00;
        }
        .action-buttons{
            display:flex;
            gap:10px;
            margin-top:20px;
        }
        .action-buttons button{
            flex:1;
            padding:12px;
            border-radius:10px;
            border:none;
            cursor:pointer;
            font-weight:bold;
        }
        .login-btn{background:#34d399;color:#1e293b;}
        .register-btn{background:#4b5563;color:#fff;}
        .google-btn{
            background:#fff;
            color:#333;
            border:none;
            padding:12px;
            margin-top:15px;
            border-radius:10px;
            font-weight:bold;
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 4px 6px rgba(0,0,0,0.1);
        }
        .google-btn i{
            margin-left:8px;
            color:#db4437;
        }
        .error-message{
            color:#ff5555;
            font-weight:bold;
            min-height:18px;
            font-size:13px;
        }

        .pending-verification{
            color:#fff;
            text-align:center;
        }
        .pending-verification i{
            font-size:40px;
            color:#34d399;
            margin-bottom:10px;
        }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ */
        .modal-profile{
            display:none;
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.7);
            z-index:9999;
            justify-content:center;
            align-items:center;
        }
        .profile-box{
            background:#2a3547;
            padding:30px;
            border-radius:10px;
            width:90%;
            max-width:400px;
            color:#fff;
        }
        .profile-box h3{
            color:#34d399;
            margin-bottom:20px;
        }
        .profile-box input{
            width:100%;
            margin-bottom:10px;
            padding:10px;
            background:#374151;
            border-radius:8px;
            border:1px solid #4b5563;
            color:#fff;
            box-sizing:border-box;
        }
        .save-btn,.secondary-btn{
            width:100%;
            padding:10px;
            border:none;
            border-radius:8px;
            cursor:pointer;
            margin-top:5px;
        }
        .save-btn{background:#00a884;color:#fff;}
        .secondary-btn{background:#4b5563;color:#fff;}
    </style>
</head>
<body>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div class="modal" id="loginModal">
        <div class="modal-box">
            <div id="authContent">
                <div class="title">ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
                <p style="text-align:center;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„</p>

                <button class="google-btn" onclick="signInWithGoogle()">
                    <i class="fa-brands fa-google"></i> Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„
                </button>

                <hr style="border-top:1px solid rgba(255,255,255,0.1);margin:25px 0 15px;">

                <div class="input-group">
                    <input type="text" id="emailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                </div>
                <div class="input-group">
                    <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                </div>

                <p class="error-message" id="authError"></p>

                <div class="action-buttons">
                    <button class="login-btn" onclick="loginUser()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
                    <button class="register-btn" onclick="registerUser()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                </div>
            </div>

            <div id="verificationPending" style="display:none;" class="pending-verification">
                <i class="fa-solid fa-envelope-circle-check"></i>
                <h3>ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                <p>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.</p>
                <p style="font-size:14px;margin-top:15px;">Ø§ÙØªØ­ Ø¨Ø±ÙŠØ¯Ùƒ (Gmail) ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø«Ù… Ø§Ø±Ø¬Ø¹ ÙˆØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„.</p>
                <button style="margin-top:20px;background:#34d399;color:#1e293b;padding:10px 15px;border-radius:10px;border:none;cursor:pointer;"
                        onclick="auth.signOut()">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ -->
    <div class="modal-profile" id="profileModal">
        <div class="profile-box">
            <h3>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ğŸ‘¤</h3>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©:</label>
            <input type="text" id="profileDisplayName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
            <input type="text" id="profileEmail" disabled>
            <p class="error-message" id="profileError"></p>
            <button class="save-btn" onclick="updateDisplayName()">Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…</button>
            <button class="secondary-btn" onclick="document.getElementById('profileModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <div class="app-container" style="display:none;">
        <div class="chat-header">
            <div>
                <div style="font-weight:bold;">Ø´Ø§Øª Ø£Ø¨Ùˆ Ø£Ù…ÙŠØ±</div>
                <div id="headerRoomName" style="font-size:13px;">Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
            </div>
            <div>
                <button class="icon-btn" style="color:#fff;margin-left:10px;" onclick="showProfileModal()">
                    <i class="fa-solid fa-user"></i>
                </button>
                <button class="icon-btn" style="color:#fff;" onclick="logoutUser()">
                    <i class="fa-solid fa-right-from-bracket"></i> Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>

        <div class="messages-area" id="messagesList"></div>

        <div class="input-area">
            <input type="file" id="imgInput" accept="image/*" style="display:none;" onchange="handleImageSelect()">
            <button class="icon-btn" onclick="document.getElementById('imgInput').click()">
                <i class="fa-solid fa-camera"></i>
            </button>
            <button class="icon-btn" id="micBtn" onclick="toggleRecording()">
                <i class="fa-solid fa-microphone"></i>
            </button>
            <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
            <button class="icon-btn" onclick="sendMessage()">
                <i class="fa-solid fa-paper-plane" style="color:#008069;"></i>
            </button>
        </div>
    </div>

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ù†ÙØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ù…Ø´Ø±ÙˆØ¹Ùƒ)
        const firebaseConfig = {
            apiKey: "AIzaSyBPapPdivEQO1UPqQdCRTBI6ct8KZDtqyw",
            authDomain: "sjfie-bed64.firebaseapp.com",
            projectId: "sjfie-bed64",
            storageBucket: "sjfie-bed64.firebasestorage.app",
            messagingSenderId: "67450727104",
            appId: "1:67450727104:web:4d271f44bab9740571db25"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db   = firebase.firestore();

        let myName = "";
        const defaultRoom = "MainRoom";
        let mediaRecorder, audioChunks = [], isRecording = false;

        function showError(msg){
            document.getElementById('authError').innerText = msg || "";
        }

        // Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
        function showProfileModal(){
            const user = auth.currentUser;
            if(!user) return;
            document.getElementById('profileEmail').value = user.email || "";
            document.getElementById('profileDisplayName').value =
                user.displayName || (user.email ? user.email.split('@')[0] : "Ù…Ø³ØªØ®Ø¯Ù…");
            document.getElementById('profileError').innerText = "";
            document.getElementById('profileModal').style.display = 'flex';
        }

        function updateDisplayName(){
            const newName = document.getElementById('profileDisplayName').value.trim();
            const profileError = document.getElementById('profileError');
            if(!newName){
                profileError.innerText = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­.";
                return;
            }
            const user = auth.currentUser;
            if(!user){
                profileError.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„.";
                return;
            }
            user.updateProfile({displayName:newName})
                .then(()=>{
                    myName = newName;
                    profileError.innerText = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­.";
                    setTimeout(()=>{document.getElementById('profileModal').style.display='none';},1200);
                })
                .catch(e=>profileError.innerText="ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: "+e.message);
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… redirect (Ø£Ù†Ø³Ø¨ Ù„Ù„Ø¬ÙˆØ§Ù„)
        function signInWithGoogle(){
            showError("");
            firebase.auth().useDeviceLanguage();
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithRedirect(provider);
        }

        // Ø¥Ø°Ø§ Ø±Ø¬Ø¹Ù†Ø§ Ù…Ù† Ø¬ÙˆØ¬Ù„ Ø¨Ø¹Ø¯ redirect Ù†Ù„ØªÙ‚Ø· Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙ‚Ø·)
        auth.getRedirectResult()
            .then((result)=>{
                if(result.user){
                    console.log("Google login:", result.user.email);
                }
            })
            .catch((error)=>{
                console.log("Google Redirect Error:", error);
                showError("ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„: " + error.message);
            });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        auth.onAuthStateChanged(user=>{
            const appContainer = document.querySelector('.app-container');
            const loginModal   = document.getElementById('loginModal');

            if(user){
                const isEmailPassword = user.providerData.some(p=>p.providerId === 'password');
                if(isEmailPassword && !user.emailVerified){
                    document.getElementById('authContent').style.display='none';
                    document.getElementById('verificationPending').style.display='flex';
                    appContainer.style.display='none';
                    loginModal.style.display='flex';
                    return;
                }

                myName = user.displayName || (user.email ? user.email.split('@')[0] : "Ù…Ø³ØªØ®Ø¯Ù…");

                startApp();
                loginModal.style.display='none';
                appContainer.style.display='flex';
            }else{
                document.getElementById('authContent').style.display='block';
                document.getElementById('verificationPending').style.display='none';
                loginModal.style.display='flex';
                appContainer.style.display='none';
                showError("");
            }
        });

        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯
        function loginUser(){
            const email = document.getElementById('emailInput').value.trim();
            const pass  = document.getElementById('passwordInput').value;
            if(!email || !pass) return showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
            auth.signInWithEmailAndPassword(email,pass)
                .then(()=>showError(""))
                .catch(err=>{
                    if(err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password')
                        showError("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
                    else
                        showError("ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + err.message);
                });
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ + Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªÙØ¹ÙŠÙ„
        function registerUser(){
            const email = document.getElementById('emailInput').value.trim();
            const pass  = document.getElementById('passwordInput').value;
            if(!email || !pass) return showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
            if(pass.length < 6) return showError("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±.");

            auth.createUserWithEmailAndPassword(email,pass)
                .then(cred=>cred.user.sendEmailVerification())
                .then(()=>{
                    document.getElementById('authContent').style.display='none';
                    document.getElementById('verificationPending').style.display='flex';
                    showError("");
                })
                .catch(err=>{
                    if(err.code === 'auth/email-already-in-use')
                        showError("Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø¬Ø±Ù‘Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
                    else
                        showError("ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + err.message);
                });
        }

        function logoutUser(){
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")){
                auth.signOut();
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        function startApp(){
            document.getElementById('headerRoomName').innerText = "Ø§Ù„ØºØ±ÙØ©: MainRoom";
            cleanOldMessages();
            loadMessages();
        }

        function cleanOldMessages(){
            const oneDayAgo = new Date(Date.now() - 24*60*60*1000);
            db.collection("messages")
              .where("room","==",defaultRoom)
              .where("timestamp","<",oneDayAgo).get()
              .then(snap=>snap.forEach(doc=>doc.ref.delete()));
        }

        function loadMessages(){
            db.collection("messages")
              .where("room","==",defaultRoom)
              .orderBy("timestamp","asc")
              .onSnapshot(snap=>{
                  const list = document.getElementById('messagesList');
                  list.innerHTML = "";
                  const user = auth.currentUser;

                  snap.forEach(doc=>{
                      const msg = doc.data();
                      const div = document.createElement('div');
                      const isMine = user && (msg.sender === myName || msg.sender === user.email);

                      div.className = "message " + (isMine ? "mine" : "others");

                      let content = "";
                      if(msg.type === 'image'){
                          content = `<img src="${msg.content}" style="max-width:100%;border-radius:10px;">`;
                      }else if(msg.type === 'audio'){
                          content = `<audio controls src="${msg.content}"></audio>`;
                      }else{
                          content = msg.content;
                      }

                      div.innerHTML = `
                        ${!isMine ? `<span class="sender-name">${msg.sender}</span>` : ""}
                        <div>${content}</div>
                        <span class="msg-time">
                            ${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '...'}
                        </span>
                      `;
                      list.appendChild(div);
                  });

                  list.scrollTop = list.scrollHeight;
              });
        }

        // ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª
        async function toggleRecording(){
            const micBtn = document.getElementById('micBtn');
            if(!isRecording){
                try{
                    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = ()=>{
                        const blob = new Blob(audioChunks,{type:'audio/webm'});
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = ()=>pushToFirebase(reader.result,'audio');
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    micBtn.classList.add('recording');
                    setTimeout(()=>{if(isRecording) toggleRecording();},60000);
                }catch(e){
                    alert("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†.");
                }
            }else{
                mediaRecorder.stop();
                isRecording = false;
                micBtn.classList.remove('recording');
            }
        }

        // ØµÙˆØ±Ø©
        function handleImageSelect(){
            const file = document.getElementById('imgInput').files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e=>{
                const img = new Image();
                img.src = e.target.result;
                img.onload = ()=>{
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxW = 500;
                    const scale = maxW / img.width;
                    canvas.width = maxW;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img,0,0,canvas.width,canvas.height);
                    pushToFirebase(canvas.toDataURL('image/jpeg',0.7),'image');
                };
            };
            reader.readAsDataURL(file);
        }

        function sendMessage(){
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if(!text) return;
            pushToFirebase(text,'text');
            input.value = "";
        }

        function pushToFirebase(content,type){
            db.collection("messages").add({
                content,
                type,
                sender:myName,
                room:defaultRoom,
                timestamp:firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        document.getElementById('msgInput').addEventListener('keypress',e=>{
            if(e.key === "Enter") sendMessage();
        });

        setInterval(cleanOldMessages,60000);
    </script>
</body>
</html>
